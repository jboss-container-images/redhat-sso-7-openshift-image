schema_version: 1
name: sso.security.cve-2020-10695
version: '1.0'
description: "Avoid CVE-2020-10695 by generating a new passwd file based on the
  chosen user ID and instructing the NSS wrapper to use this passwd file rather
  than to loosen the permissions of the system's /etc/passwd file from its
  default recommended 644 setting.

  Note: This module can be removed altogether once Red Hat Single Sign-On 7
        OpenShift container images don't need to support OpenShift v3.x.

        Starting from OpenShift v4.2 onward the CRI-O OpenShift run-time engine
        inserts the random user for the container into /etc/passwd:
        * https://access.redhat.com/articles/4859371
        * https://github.com/cri-o/cri-o/pull/2022/commits/77408ef1490002e62c88baacc5c994e97aa793c6

        which avoids the need to perform additional custom modification on
        per image basis to achieve image support for arbitrary user IDs."

envs:
- name: HOME
  value: "/home/jboss"
  # Per https://access.redhat.com/articles/4859371 for Java based processes
  # specify also 'user.home' property
- name: MAVEN_OPTS
  value: "-Duser.home=$HOME"
  # Propagate the fact about utilizing nss_wrapper to the subsequent modules
- name: LD_PRELOAD
  value: "libnss_wrapper.so"
- name: NSS_WRAPPER_PASSWD
  value: "/etc/rh-sso/passwd"
- name: NSS_WRAPPER_GROUP
  value: "/etc/group"

packages:
  install:
  # Dependencies of the original 'jboss.container.user' module
  - unzip
  - tar
  - rsync
  - shadow-utils
  # NSS API dependencies
  - nss_wrapper
  # Needed for mkhomedir_helper
  - pam

execute:
- script: configure.sh
